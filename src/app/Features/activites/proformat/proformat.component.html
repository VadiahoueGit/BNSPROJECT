<div class="gap-2 d-flex align-items-center mb-3" style="cursor: pointer;" (click)="goBack()">
  <i style="font-size: 18px;" class="fas fw-bold fa-chevron-left me-2"></i>
  <h4 class="fw-bold mb-0">Proforma</h4>
</div>
<div class="card">
  <div class="row">
    <div class="col-12 col-sm-6 col-md-3 mb-3">
      <span>Numéro commande :</span>
      <span class="p-input-icon-left w-100 d-flex align-items-center">
        <i class="fas fa-search"></i>
        <input
          class="w-100"
          style="border-radius: 7px"
          pInputText
          type="text"
          [(ngModel)]="filters.numeroCommande"
          (keydown.enter)="filterGlobal()"
          placeholder="Recherche"
        />
      </span>
    </div>
    <div class="col-12 col-sm-6 col-md-3 mb-3">
      <span>Date :</span>
      <span class="p-input-icon-left w-100 d-flex align-items-center">
        <i class="fas fa-search"></i>
        <input
          class="w-100"
          style="border-radius: 7px"
          pInputText
          type="text"
          [(ngModel)]="filters.date"
          (keydown.enter)="filterGlobal()"
          placeholder="Recherche"
        />
      </span>
    </div>
    <div class="col-12 col-sm-6 col-md-3 mb-3">
      <span>Etablissement :</span>
      <span class="p-input-icon-left w-100 d-flex align-items-center">
        <i class="fas fa-search"></i>
        <input
          class="w-100"
          style="border-radius: 7px"
          pInputText
          type="text"
          [(ngModel)]="filters.etablissement"
          (keydown.enter)="filterGlobal()"
          placeholder="Recherche"
        />
      </span>
    </div>
    <div class="col-12 col-sm-6 col-md-3 mb-3">
      <span>Statut :</span>
      <span class="p-input-icon-left w-100 d-flex align-items-center">
        <i class="fas fa-search"></i>
        <input
          class="w-100"
          style="border-radius: 7px"
          pInputText
          type="text"
          [(ngModel)]="filters.statut"
          (keydown.enter)="filterGlobal()"
          placeholder="Recherche"
        />
      </span>
    </div>
  </div>
  <p-table
    [styleClass]="'p-datatable-sm'"
    #dt2
    [value]="dataList"
    dataKey="id"
    [rows]="8"
    [totalRecords]="totalPages" [lazy]="true"
    [rowsPerPageOptions]="[10, 25, 50]"
    [paginator]="true"
    (onPage)="onPage($event)"
  >
    <ng-template pTemplate="header">
      <tr>
        <th style="color: var(--secondary-color)">Source</th>
        <th style="color: var(--secondary-color)">Date</th>
        <th style="color: var(--secondary-color)">Numéro de commande</th>
        <th style="color: var(--secondary-color)">Etablissements</th>
        <th style="color: var(--secondary-color)">Entrepôt</th>
        <th style="color: var(--secondary-color)">Statut</th>
        <th style="color: var(--secondary-color)">Action(s)</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-dataList>
      <tr>
        <td>
          <i
            *ngIf="dataList.source == 'APPMOB'"
            class="fa-solid text-secondary fa-mobile-notch"
          ></i>
          <i
            *ngIf="dataList.source == 'BO'"
            class="fa-regular text-secondary fa-desktop"
          ></i>
        </td>
        <td>
          <span class="ml-1 vertical-align-middle">
            {{ dataList.dateCreation | date }}
          </span>
        </td>
        <td>
          <span class="ml-1 vertical-align-middle">
            {{ dataList.NumCommande }}
          </span>
        </td>
        <td>
          {{
            dataList.client.nomEtablissement
              ? dataList.client.nomEtablissement
              : dataList.client.raisonSocial
          }}
        </td>
        <td>
          <span class="ml-1 vertical-align-middle">
            {{ dataList.client.depot.nomDepot }}
          </span>
        </td>
        <td>
          <span class="ml-1 vertical-align-middle">
            {{ dataList.statut }}
          </span>
        </td>
        <td>
      <tr class="d-flex justify-content-center gap-3">
        <td>
          <i
            (click)="OnView(dataList)"
            style="cursor: pointer"
            class="fas fa-eye text-secondary"
          ></i>
        </td>
      </tr>
      </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="5">Aucune commande trouvé.</td>
      </tr>
    </ng-template>
  </p-table>
</div>

<!-- Modal creation -->
<!-- Modal -->

<div *ngIf="isModalOpen" class="custom-modal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <!-- Modal Header -->
      <div class="modal-header d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
          <div
            class="d-flex justify-content-center align-items-center"
            style="
              background-color: rgb(219, 255, 232);
              border-radius: 3rem;
              width: 3rem;
              height: 3rem;
            "
          >
            <i class="fas fa-box-check text-primary fs-3"></i>
          </div>
          <h1
            *ngIf="operation == 'edit'"
            class="modal-title fs-5 ms-3"
            id="staticBackdropLabel"
          >
            Détails de la commande
          </h1>
        </div>
        <div class=" py-3">
          <button type="button" class="btn btn-secondary px-4" (click)="DownloadFacture(updateData.factureProFormat.id)">
            Imprimer
          </button>
        </div>
      </div>

      <!-- Barre de recherche client centrée -->
      <div class="modal-body" style="max-height: 70vh; overflow-y: auto">
        <div *ngIf="operation == 'edit'">
          <fieldset class="row border my-1" *ngIf="operation == 'edit'">
            <legend style="font-size: 14px" class="text-secondary">
              Numero Commande : {{ updateData.NumCommande }} du
              {{ updateData.dateCreation | date }}
            </legend>
          </fieldset>
          <fieldset class="row border my-2">
            <legend style="font-size: 14px" class="text-secondary">
              Informations du client
            </legend>
            <div class="row">
              <div class="col-md-4">
                <strong>Groupe de client :</strong>
                <span>{{
                    updateData.client?.groupeClient?.nomGroupe ||
                    updateData.client?.GroupeClient?.nomGroupe
                  }}</span>
              </div>
              <div class="col-md-4">
                <strong>Type de client :</strong>
                <span>{{ updateData.client.role }}</span>
              </div>
              <div class="col-md-4">
                <strong>Propriétaire :</strong>
                <span>{{ updateData.client.nomProprietaire }}</span>
              </div>
              <div class="col-md-4">
                <strong>Gérant :</strong>
                <span>{{ updateData.client.nomGerant }}</span>
              </div>
              <div class="col-md-4">
                <strong>Établissement :</strong>
                <span>{{
                    updateData.client.nomEtablissement
                      ? updateData.client.nomEtablissement
                      : updateData.client.raisonSocial
                  }}</span>
              </div>
              <div class="col-md-4">
                <strong>Numero de registre :</strong>
                <span>{{ updateData.client.numeroRegistre }}</span>
              </div>
              <div class="col-md-4">
                <strong>Numero contribuable :</strong>
                <span>{{ updateData.client.numeroCompteContribuable }}</span>
              </div>
              <div class="col-md-4">
                <strong>Contact Gérant :</strong>
                <span>{{ updateData.client.telephoneGerant }}</span>
              </div>
              <div class="col-md-4 mb-4">
                <strong>Téléphone :</strong>
                <span>{{ updateData.client.telephoneProprietaire }}</span>
              </div>
              <div class="col-md-4 mb-4">
                <strong>Numero SAP : </strong>
                <span>{{ updateData.client.numeroSAP?.numeroSAP || "N/A" }}</span>
              </div>
              <div class="col-md-4 mb-4">
                <strong>Solde liquide :</strong>
                <span>{{ updateData.soldeLiquide | currency : "XOF" }}</span>
              </div>
              <div class="col-md-4 mb-4">
                <strong>Solde Emballage :</strong>
                <span>{{ updateData.soldeEmballage | currency : "XOF" }}</span>
              </div>
            </div>
          </fieldset>
        </div>

        <div class="p-2 mt-3">
          <div style="max-height: 350px; overflow-y: auto">
            <table *ngIf="operation == 'edit'" class="table table-bordered">
              <thead class="table-success">
              <!-- Première ligne d'en-tête -->
              <tr>
                <th scope="col" colspan="5">PRIX UNITAIRE TTC(FCFA)</th>
                <th scope="col" colspan="3">MONTANT TTC(FCFA)</th>
              </tr>
              <!-- Deuxième ligne d'en-tête -->
              <tr>
                <th scope="col">Liquide</th>
                <th scope="col">Liquide (FCFA)</th>
                <th scope="col">Emballage (FCFA)</th>
                <th scope="col">Total (FCFA)</th>
                <th scope="col">Qte</th>
                <th scope="col">Liquide (FCFA)</th>
                <th scope="col">Emballage (FCFA)</th>
                <th scope="col">Total (FCFA)</th>
              </tr>
              </thead>

              <tbody>
              <tr *ngFor="let item of updateData?.articles">
                <td>{{ item.liquide.libelle }}1</td>
                <td>{{ item.prixUnitaireLiquide | number}}</td>
                <td>{{ item.prixUnitaireEmballage | number}}</td>
                <td>{{ Number(item.prixUnitaireLiquide ?? 0) + Number(item.prixUnitaireEmballage ?? 0) | number}}</td>
                <td>{{ item.quantite }}</td>
                <td>{{ item.montantLiquide | number}}</td>
                <td>{{ item.montantEmballage | number}}</td>
                <td>{{ Number(item.montantLiquide ?? 0) + Number(item.montantEmballage ?? 0) | number}}</td>

              </tr>
              <tr class="table-dark">
                <th scope="col" colspan="4">Total :</th>
                <td>{{ totalQte| number }}</td>
                <td>{{ totalLiquide | number}}</td>
                <td>{{ totalEmballage | number}}</td>
                <td>{{ totalGlobal | number}}</td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer gap-3 px-4">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="OnCloseModal()"
        >
          Annuler
        </button>
      </div>
    </div>
  </div>
</div>
