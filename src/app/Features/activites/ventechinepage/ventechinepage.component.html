<div class="card">
  <div class="d-flex justify-content-end py-3">
    <button type="button" class="btn btn-secondary px-4" (click)="OnCreate()">
      Planifier vente
    </button>
  </div>
  <p-table
    [styleClass]="'p-datatable-sm'"
    #dt2
    [value]="dataList"
    dataKey="id"
    [rows]="8"
    [rowsPerPageOptions]="[10, 25, 50]"
    [paginator]="true"
    (onPage)="onPage($event)"
  >
    <ng-template pTemplate="header">
      <tr>
        <th style="color: var(--secondary-color)">Commercial</th>
        <th style="color: var(--secondary-color)">Localité</th>
        <th style="color: var(--secondary-color)">Date</th>
        <th style="color: var(--secondary-color)">Statut</th>
        <th class="d-flex justify-content-center" style="color: var(--secondary-color)">Action</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-dataList>
      <tr>
        <td>
          <span class="">
            {{ dataList.commercial.nom }} {{ dataList.commercial.prenom }}
          </span>
        </td>
        <td>
          {{ dataList.localite.nomLocalite }}
        </td>
        <td>
          {{ dataList.dateVente |date}}
        </td>
        <td>
          {{ dataList.statut}}
        </td>
        <td>
          <tr class="d-flex justify-content-center gap-3">
            <td>
              <i
                (click)="OnEdit(dataList)"
                style="cursor: pointer"
                class="fas fa-eye text-secondary"
              ></i>
            </td>

          </tr>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="5">Aucune vente trouvée.</td>
      </tr>
    </ng-template>
  </p-table>
</div>

<!-- Modal creation -->
<!-- Modal -->
<div *ngIf="isModalOpen" class="custom-modal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header d-flex align-items-center">
        <div
          class="d-flex justify-content-center align-items-center"
          style="
            background-color: rgb(219, 255, 232);
            border-radius: 3rem;
            width: 3rem;
            height: 3rem;
          "
        >
          <i class="fas fa-box-check text-primary fs-3"></i>
        </div>
        <h1
          *ngIf="operation == 'create'"
          class="modal-title fs-5 ms-3"
          id="staticBackdropLabel"
        >
          Création vente chine
        </h1>
        <h1
          *ngIf="operation == 'edit'"
          class="modal-title fs-5 ms-3"
          id="staticBackdropLabel"
        >
          Détail vente chine
        </h1>
      </div>

      <div class="modal-body">
        <div class="row">
          <form [formGroup]="VenteForm" *ngIf="operation == 'create'">
            <fieldset class="row border my-2">
              <legend class="fs-6 text-primary">Ressources & chargement</legend>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label"
                    >Commercial <span class="text-danger">*</span></label
                  >
                  <ng-select
                    class="form-control"
                    [items]="dataListCommercial"
                    bindLabel="fullLabel"
                    bindValue="id"
                    formControlName="commercialId"
                    [searchable]="true"
                    (change)="onCommercialChange($event)"
                  >
                  </ng-select>
                </div>
                <div class="mb-3">
                  <label class="form-label"
                    >Localité <span class="text-danger">*</span></label
                  >
                  <ng-select
                    class="form-control"
                    [items]="dataListLocalite"
                    bindLabel="nomLocalite"
                    bindValue="id"
                    formControlName="localiteId"
                    [searchable]="true"
                  >
                  </ng-select>
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label"
                    >Date <span class="text-danger">*</span></label
                  >
                  <input
                    type="date"
                    class="form-control"
                    formControlName="venteDate"
                  />
                </div>
                <div class="mb-3">
                  <label class="form-label"
                    >Camion <span class="text-danger">*</span></label
                  >
                  <ng-select
                    class="form-control"
                    [items]="dataListCamion"
                    bindLabel="marque"
                    bindValue="id"
                    formControlName="vehiculeId"
                    [searchable]="true"
                  >
                  </ng-select>
                </div>
              </div>
              <div class="col-md-4">
                <button
                  type="button"
                  class="btn btn-secondary"
                  (click)="selectArticle()"
                  [disabled]="VenteForm.controls['commercialId'].invalid"
                >
                  Ajouter des articles
                </button>
              </div>
            </fieldset>
          </form>
          <fieldset class="row border my-1" *ngIf="operation == 'edit'">
            <legend style="font-size: 14px" class="text-secondary">
              Information Livraison
            </legend>

             <div class="row">
              <div class="col-md-4">
                <strong>Commercial: </strong>
                <span>{{ updateData.commercial.nom }} {{ updateData.commercial.nom }}</span>
              </div>
              <div class="col-md-4">
                <strong>Localité: </strong>
                <span>{{ updateData.localite.nomLocalite }}</span>
              </div>
              <div class="col-md-4">
                <strong>Dépot: </strong>
                <span>{{ updateData.commercial.depot.nomDepot }}</span>
              </div>
             </div>
          </fieldset>
          <fieldset class="row border my-2" *ngIf="operation == 'edit'">
            <legend style="font-size: 14px" class="text-secondary">
              Informations du véhicule
            </legend>
            <div class="row">
              <div class="col-md-4">
                <strong>Marque: </strong>
                <span>{{ updateData.vehicule.marque }}</span>
              </div>
              <div class="col-md-4">
                <strong>Immatriculation : </strong>
                <span>{{ updateData.vehicule.immatriculation }}</span>
              </div>
              <div class="col-md-4">
                <strong>Energie : </strong>
                <span>{{ updateData.vehicule.energie }}</span>
              </div>
              <div class="col-md-4">
                <strong>Capacité : </strong>
                <span>{{ updateData.vehicule.capacite }}</span>
              </div>
            </div>
          </fieldset>
          <fieldset class="row border my-2">
            <legend class="fs-6 text-primary">Cargaison</legend>
            <div
              *ngIf="operation == 'edit'"
              class="table-responsive"
              style="max-height: 300px; overflow-y: auto"
            >
              <table class="table">
                <thead>
                  <tr style="font-size: small">
                    <th scope="col">Produits</th>
                    <th scope="col">Qte liquide</th>
                    <th scope="col">Prix liquide</th>
                    <th scope="col">Prix emballage</th>
                    <th scope="col">Prix total</th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    style="font-size: small"
                    *ngFor="let item of updateData.articles; let i = index"
                  >
                    <td>{{ item.liquide.libelle }}</td>
                    <td>{{ item.quantite }}</td>

                    <td>{{  item.prixUnitaireLiquide}}</td>
                    <td>{{ item.prixUnitaireEmballage}}</td>
                    <td>{{ item.prixTotal}}</td>

                  </tr>
                  <tr class="table-dark" *ngIf="updateData.articles.length > 0">
                    <th scope="col" colspan="1">Total :</th>
                    <td>{{ totalQte }}</td>
                    <td>{{ totalLiquide }}</td>
                    <td>{{ totalEmballage }}</td>
                    <td>{{ totalGlobal }}</td>
                  </tr>
                  <!-- Ajoutez d'autres lignes si nécessaire -->
                </tbody>
              </table>
            </div>
            <div
              *ngIf="operation == 'create'"
              class="table-responsive"
              style="max-height: 300px; overflow-y: auto"
            >
              <table  class="table table-bordered">
                <thead class="table-success">
                <tr>
                  <th scope="col">Produits</th>
                  <th scope="col">Qte liquide</th>
                  <th scope="col">Prix liquide</th>
                  <th scope="col">Prix emballage</th>
                  <th scope="col">Prix total</th>
                  <th scope="col">Action</th>
                </tr>
                </thead>

                <tbody>
                <tr *ngFor="let item of selectedArticles">
                  <td>{{ item.liquide.libelle }}</td>
                  <td>
                    <input
                      type="number"
                      class="form-control-custom"
                      [(ngModel)]="item.quantite"
                      [min]="0"
                      [max]="stocksDisponibles[item.liquide.id]"
                      [disabled]="stocksDisponibles[item.liquide.id] === 0"
                      [ngClass]="{
                        invalid: item.quantite > stocksDisponibles[item.liquide.id]
                      }"
                      (blur)="validateQuantite(item)"
                    />
                    / {{stocksDisponibles[item.liquide.id]}}
                  </td>
                  <td>{{ prixLiquideTotal[item.id] }}</td>
                  <td>{{ prixEmballageTotal[item.id] }}</td>
                  <td>{{ montantTotal[item.id] }}</td>
                  <td class="d-flex justify-content-center">
                    <button
                      type="button"
                      class="btn btn-danger btn-sm"
                      (click)="removeArticle(item)"
                    >
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
                <tr class="table-dark">
                  <th scope="col" colspan="1">Total :</th>
                  <td>{{ totalQte }}</td>
                  <td>{{ totalLiquide }}</td>
                  <td>{{ totalEmballage }}</td>
                  <td>{{ totalGlobal }}</td>
                </tr>
                </tbody>
              </table>

            </div>
          </fieldset>
        </div>
      </div>
      <div class="modal-footer gap-3 px-4y">
        <button
          (click)="OnCloseModal()"
          type="button"
          class="btn btn-secondary px-2"
        >
          Annuler
        </button>
        <button
          type="submit"
          *ngIf="operation == 'create'"
          [disabled]="totalQte === 0"
          (click)="onSubmit()"
          class="btn btn-primary px-2"
        >
          Valider
        </button>
      </div>
    </div>
  </div>
</div>

<!--CHOIX ARTICLE-->
<div *ngIf="isChoiceModalOpen" class="custom-modal">
  <div class="modal-dialog2 modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header d-flex align-items-center">
        <div
          class="d-flex justify-content-center align-items-center"
          style="
            background-color: rgb(219, 255, 232);
            border-radius: 3rem;
            width: 3rem;
            height: 3rem;
          "
        >
          <i class="fas fa-box-check text-primary fs-3"></i>
        </div>
        <h1 class="modal-title fs-5 ms-3" id="staticBackdropLabel">
          Selection des articles
        </h1>
      </div>

      <div class="modal-body">
        <form>
          <div class="row">
            <fieldset class="row border my-2">
              <div class="p-3">
                <!-- Champ de recherche -->
                <input
                  type="text"
                  name="search"
                  (input)="filterArticles()"
                  [(ngModel)]="searchTerm"
                  placeholder="Rechercher un produit"
                  class="form-control mb-3"
                />
              </div>
              <div
                class="table-responsive"
                style="max-height: 200px; overflow-y: auto"
              >
                <table class="table">
                  <thead>
                  <tr style="font-size: small">
                    <th scope="col" class="text-secondary">Code</th>
                    <th scope="col" class="text-secondary">Produits</th>
                    <th scope="col" class="text-secondary">Disponibilité</th>
                    <th scope="col" class="text-secondary text-center">
                      Choix
                    </th>
                  </tr>
                  </thead>
                  <tbody>
                  <tr
                    *ngFor="let article of filteredArticleList ; let i = index"
                    style="font-size: small"
                  >
                    <th scope="row">{{ article.code }}</th>
                    <th scope="row">{{ article.libelle }}</th>
                    <th scope="row">{{stocksDisponibles[article.liquide.id]}}</th>
                    <td class="">
                      <input
                        type="checkbox"
                        class="form-control-custom"
                        [name]="'checkbox_' + i"
                        [(ngModel)]="article.isChecked"
                        (change)="onCheckboxChange(article)"
                        [disabled]="stocksDisponibles[article.liquide.id] <=0"
                      />

                    </td>
                  </tr>
                  </tbody>
                </table>
              </div>
            </fieldset>
          </div>
        </form>
      </div>
      <div class="modal-footer gap-3 px-4y">
        <button
          (click)="OnCloseChoiceModal()"
          type="button"
          class="btn btn-secondary px-2"
        >
          Annuler
        </button>
        <button
          type="submit"
          (click)="onSubmitSelection()"
          class="btn btn-primary px-2"
        >
          Valider
        </button>
      </div>
    </div>
  </div>
</div>
