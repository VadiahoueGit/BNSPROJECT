<div class="card">
  <div class="d-flex justify-content-end py-3">
    <button type="button" class="btn btn-secondary px-4" (click)="OnCreate()">
      Saisir une commande
    </button>
  </div>
  <p-table
    [styleClass]="'p-datatable-sm'"
    #dt2
    [value]="dataList"
    dataKey="id"
    [rows]="8"
    [rowsPerPageOptions]="[10, 25, 50]"
    [paginator]="true"
    (onPage)="onPage($event)"
  >
    <ng-template pTemplate="header">
      <tr>
        <th style="color: var(--secondary-color)">Numéro commande</th>
        <th style="color: var(--secondary-color)">Raison sociale</th>
        <th style="color: var(--secondary-color)">Numéro compte</th>
        <th style="color: var(--secondary-color)">Numéro SAP</th>
        <th style="color: var(--secondary-color)">Remise</th>
        <th style="color: var(--secondary-color)">Solde emballage</th>
        <th style="color: var(--secondary-color)">Solde liquide</th>
        <th style="color: var(--secondary-color)">Statut compte</th>
        <th style="color: var(--secondary-color)">Actions</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-dataList>
      <tr>
        <td>
          <span class="ml-1 vertical-align-middle">
            {{ dataList.NumCommande }}
          </span>
        </td>
        <td>
          {{ dataList.raisonSociale }}
        </td>
        <td>
          <span class="ml-1 vertical-align-middle">
            {{ dataList.numeroCompte }}
          </span>
        </td>
        <td>
          {{ dataList.numeroSAP }}
        </td>
        <td>
          <span class="ml-1 vertical-align-middle">
            {{ dataList.remise }}
          </span>
        </td>
        <td>
          <span class="ml-1 vertical-align-middle">
            {{ dataList.soldeEmballage }}
          </span>
        </td>
        <td>
          <span class="ml-1 vertical-align-middle">
            {{ dataList.soldeLiquide }}
          </span>
        </td>
        <td>
          <span class="ml-1 vertical-align-middle">
            {{ dataList.statutCompte }}
          </span>
        </td>
        <td>
          <!-- <span class="ml-1 vertical-align-middle">
                        {{ dataList.plastiquenu.libelle }}
                    </span> -->
        </td>
        <td>
          <tr class="d-flex justify-content-center gap-3">
            <td>
              <i
                (click)="OnEdit(dataList)"
                style="cursor: pointer"
                class="fas fa-eye text-secondary"
              ></i>
            </td>
            <td>
              <i
                (click)="OnDelete(dataList.id)"
                style="cursor: pointer"
                class="fas fa-trash-alt text-danger"
              ></i>
            </td>
          </tr>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="5">Aucune commande trouvé.</td>
      </tr>
    </ng-template>
  </p-table>
</div>

<!-- Modal creation -->
<!-- Modal -->

<div *ngIf="isModalOpen" class="custom-modal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <!-- Modal Header -->
      <div class="modal-header d-flex align-items-center">
        <div
          class="d-flex justify-content-center align-items-center"
          style="
            background-color: #dbffe8;
            border-radius: 50%;
            width: 3rem;
            height: 3rem;
          "
        >
          <i class="fas fa-box-check text-success fs-4"></i>
        </div>
        <h1 class="modal-title fs-5 ms-3">Gestion des commandes clients</h1>
        <button
          type="button"
          class="btn-close"
          aria-label="Close"
          (click)="OnCloseModal()"
        ></button>
      </div>

      <!-- Barre de recherche client centrée -->
      <div class="modal-body" style="max-height: 70vh; overflow-y: auto">
        <form [formGroup]="commandClientForm" *ngIf="operation == 'create'">
          <div class="mb-4 text-center">
            <div class="d-flex justify-content-center gap-2">
              <div class="d-flex">
                <div class="mr-2">
                  <label for="client" class="form-label me-2 mb-0 pt-2"
                    >Client<span class="text-danger">*</span></label
                  >
                </div>
                <ng-select
                  class="form-control"
                  [items]="listRevendeurs"
                  (change)="onRevendeurChange($event)"
                  bindLabel="displayName"
                  bindValue="id"
                  formControlName="clientId"
                  [searchable]="true"
                >
                </ng-select>
              </div>
              <!-- <div class="">
                <button class="btn btn-primary w-100" type="button" (click)="onSearchClient()">Rechercher</button>
              </div> -->
            </div>
          </div>

          <!-- Formulaire: Informations client -->

          <div class="border rounded p-3 mb-4">
            <h6 class="mb-4">Informations client</h6>
            <div class="row g-3">
              <div class="col-md-4">
                <label for="numeroCompte" class="form-label"
                  >Numéro de compte<span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  id="numeroCompte"
                  formControlName="numeroCompte"
                />
              </div>
              <div class="col-md-4">
                <label for="raisonSociale" class="form-label"
                  >Raison sociale<span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  id="raisonSociale"
                  formControlName="raisonSociale"
                />
              </div>

              <div class="col-md-4">
                <label for="numeroSAP" class="form-label"
                  >Numéro SAP<span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  id="numeroSAP"
                  formControlName="numeroSAP"
                />
              </div>

              <div class="col-md-4">
                <label for="montantCredit" class="form-label"
                  >Montant crédit<span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  id="montantCredit"
                  formControlName="montantCredit"
                />
              </div>
              <div class="col-md-4">
                <label for="soldeEmballage" class="form-label"
                  >Solde emballage<span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  id="soldeEmballage"
                  formControlName="soldeEmballage"
                />
              </div>
              <div class="col-md-4">
                <label for="soldeLiquide" class="form-label"
                  >Solde liquide<span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  id="soldeLiquide"
                  formControlName="soldeLiquide"
                />
              </div>

              <div class="col-md-4">
                <label for="enCours" class="form-label"
                  >En cours<span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  id="enCours"
                  formControlName="enCours"
                />
              </div>
              <div class="col-md-4">
                <label for="statutCompte" class="form-label"
                  >Statut du compte<span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  id="statutCompte"
                  formControlName="statutCompte"
                />
              </div>
              <div class="col-md-4">
                <label for="contact" class="form-label"
                  >Contact<span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  id="contact"
                  formControlName="contact"
                />
              </div>
            </div>
          </div>

          <!-- Section: Saisie commande -->
          <div class="border rounded p-3 mb-4">
            <h6 class="mb-4">Saisie commande</h6>
            <div class="row g-3">
              <div class="col-md-4">
                <label for="fraisTransport" class="form-label"
                  >Frais transport<span class="text-danger">*</span></label
                >
                <input
                  type="number"
                  class="form-control"
                  id="fraisTransport"
                  formControlName="fraisTransport"
                  (blur)="applyFraisTransport()"
                />
              </div>

              <div class="col-md-4">
                <label for="remise" class="form-label"
                  >Remise<span class="text-danger">*</span></label
                >
                <input
                  type="number"
                  class="form-control"
                  id="remise"
                  [max]="100"
                  formControlName="remise"
                  (blur)="applyRemise()"
                />
              </div>
              <div class="col-md-4" style="margin-top: 3rem">
                <button
                  type="submit"
                  class="btn btn-primary"
                  [disabled]="
                    commandClientForm.controls['clientId'].invalid ||
                    commandClientForm.controls['remise'].invalid ||
                    commandClientForm.controls['fraisTransport'].invalid
                  "
                  (click)="selectArticle()"
                >
                  Ajouter des articles
                </button>
              </div>
            </div>
          </div>
        </form>
        <fieldset class="row border my-1" *ngIf="operation == 'edit'">
          <legend style="font-size: 14px" class="text-secondary">
            Numero Commande : {{ updateData.NumCommande }} du
            {{ updateData.dateCreation | date }}
          </legend>
        </fieldset>
        <fieldset class="row border my-2" *ngIf="operation == 'edit'">
          <legend style="font-size: 14px" class="text-secondary">
            Informations du client
          </legend>
          <div class="row">
            <div class="col-md-4">
              <strong>Groupe de client :</strong>
              <span>{{ updateData.client.groupeClient.nomGroupe }}</span>
            </div>
            <div class="col-md-4">
              <strong>Type de client :</strong>
              <span>{{ updateData.client.role }}</span>
            </div>
            <div class="col-md-4">
              <strong>Propriétaire :</strong>
              <span>{{ updateData.client.nomProprietaire }}</span>
            </div>
            <div class="col-md-4">
              <strong>Gérant :</strong>
              <span>{{ updateData.client.nomGerant }}</span>
            </div>
            <div class="col-md-4">
              <strong>Établissement :</strong>
              <span>{{
                updateData.client.nomEtablissement
                  ? updateData.client.nomEtablissement
                  : updateData.client.raisonSocial
              }}</span>
            </div>
            <div class="col-md-4">
              <strong>Numero de registre :</strong>
              <span>{{ updateData.client.numeroRegistre }}</span>
            </div>
            <div class="col-md-4">
              <strong>Numero contribuable :</strong>
              <span>{{ updateData.client.numeroCompteContribuable }}</span>
            </div>
            <div class="col-md-4">
              <strong>Contact Gérant :</strong>
              <span>{{ updateData.client.telephoneGerant }}</span>
            </div>
            <div class="col-md-4 mb-4">
              <strong>Téléphone :</strong>
              <span>{{ updateData.client.telephoneProprietaire }}</span>
            </div>
          </div>
        </fieldset>
        <div class="p-2 mt-3">
          <div style="max-height: 350px; overflow-y: auto">
            <table *ngIf="operation == 'create'" class="table table-bordered">
              <thead class="table-success">
                <!-- Première ligne d'en-tête -->
                <tr>
                  <th scope="col" colspan="5">PRIX UNITAIRE TTC(FCFA)</th>
                  <th scope="col" colspan="4">MONTANT TTC(FCFA)</th>
                </tr>
                <!-- Deuxième ligne d'en-tête -->
                <tr>
                  <th scope="col">Liquide</th>
                  <th scope="col">Liquide (FCFA)</th>
                  <th scope="col">Emballage (FCFA)</th>
                  <th scope="col">Total (FCFA)</th>
                  <th scope="col">Qte</th>
                  <th scope="col">Liquide (FCFA)</th>
                  <th scope="col">Emballage (FCFA)</th>
                  <th scope="col">Total (FCFA)</th>
                  <th scope="col">Actions</th>
                </tr>
              </thead>

              <tbody>
                <tr *ngFor="let item of selectedArticles">
                  <td>{{ item.liquide.libelle }}1</td>
                  <td>{{ prixLiquide[item.id] }}</td>
                  <td>{{ prixEmballage[item.id] }}</td>
                  <td>{{ prixEmballage[item.id] + prixLiquide[item.id] }}</td>
                  <td>
                    <input
                      type="number"
                      class="form-control-custom"
                      [(ngModel)]="item.quantite"
                      [min]="0"
                      [max]="stocksDisponibles[item.liquide.id]"
                      [disabled]="stocksDisponibles[item.liquide.id] === 0"
                      [ngClass]="{
                        invalid:
                          item.quantite > stocksDisponibles[item.liquide.id]
                      }"
                      (blur)="validateQuantite(item)"
                    />
                    / {{ stocksDisponibles[item.liquide.id] }}
                  </td>
                  <td>{{ prixLiquideTotal[item.id] }}</td>
                  <td>{{ prixEmballageTotal[item.id] }}</td>
                  <td>{{ montantTotal[item.id] }}</td>
                  <td class="d-flex justify-content-center">
                    <button
                      type="button"
                      class="btn btn-danger btn-sm"
                      (click)="removeArticle(item)"
                    >
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
                <tr class="table-dark">
                  <th scope="col" colspan="4">Total :</th>
                  <td>{{ totalQte }}</td>
                  <td>{{ totalLiquide }}</td>
                  <td>{{ totalEmballage }}</td>
                  <td>{{ totalGlobal }}</td>
                  <td></td>
                </tr>
              </tbody>
            </table>
            <table *ngIf="operation == 'edit'" class="table table-bordered">
              <thead class="table-success">
                <!-- Première ligne d'en-tête -->
                <tr>
                  <th scope="col" colspan="5">PRIX UNITAIRE TTC(FCFA)</th>
                  <th scope="col" colspan="3">MONTANT TTC(FCFA)</th>
                </tr>
                <!-- Deuxième ligne d'en-tête -->
                <tr>
                  <th scope="col">Liquide</th>
                  <th scope="col">Liquide (FCFA)</th>
                  <th scope="col">Emballage (FCFA)</th>
                  <th scope="col">Total (FCFA)</th>
                  <th scope="col">Qte</th>
                  <th scope="col">Liquide (FCFA)</th>
                  <th scope="col">Emballage (FCFA)</th>
                  <th scope="col">Total (FCFA)</th>
                </tr>
              </thead>

              <tbody>
                <tr *ngFor="let item of updateData.articles">
                  <td>{{ item.liquide.libelle }}1</td>
                  <td>{{ item.prixUnitaireLiquide }}</td>
                  <td>{{ item.prixUnitaireEmballage }}</td>
                  <td>
                    {{
                      Number(item.prixUnitaireLiquide ?? 0) +
                        Number(item.prixUnitaireEmballage ?? 0)
                    }}
                  </td>
                  <td>{{ item.quantite }}</td>
                  <td>{{ item.montantLiquide }}</td>
                  <td>{{ item.montantEmballage }}</td>
                  <td>
                    {{
                      Number(item.montantLiquide ?? 0) +
                        Number(item.montantEmballage ?? 0)
                    }}
                  </td>
                </tr>
                <tr class="table-dark">
                  <th scope="col" colspan="4">Total :</th>
                  <td>{{ totalQte }}</td>
                  <td>{{ totalLiquide }}</td>
                  <td>{{ totalEmballage }}</td>
                  <td>{{ totalGlobal }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer gap-3 px-4">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="OnCloseModal()"
        >
          Annuler
        </button>
        <button
          type="submit"
          *ngIf="operation == 'create'"
          class="btn btn-primary"
          (click)="onSubmit()"
          [disabled]="totalQte === 0"
        >
          Valider
        </button>
      </div>
    </div>
  </div>
</div>

<!--CHOIX ARTICLE-->
<div *ngIf="isChoiceModalOpen" class="custom-modal">
  <div class="modal-dialog2 modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header d-flex align-items-center">
        <div
          class="d-flex justify-content-center align-items-center"
          style="
            background-color: rgb(219, 255, 232);
            border-radius: 3rem;
            width: 3rem;
            height: 3rem;
          "
        >
          <i class="fas fa-box-check text-primary fs-3"></i>
        </div>
        <h1 class="modal-title fs-5 ms-3" id="staticBackdropLabel">
          Selection des articles
        </h1>
      </div>

      <div class="modal-body">
        <form>
          <div class="row">
            <fieldset class="row border my-2">
              <div class="p-3">
                <!-- Champ de recherche -->
                <input
                  type="text"
                  name="search"
                  (input)="filterArticles()"
                  [(ngModel)]="searchTerm"
                  placeholder="Rechercher un produit"
                  class="form-control mb-3"
                />
              </div>
              <div
                class="table-responsive"
                style="max-height: 200px; overflow-y: auto"
              >
                <table class="table">
                  <thead>
                    <tr style="font-size: small">
                      <th scope="col" class="text-secondary">Produits</th>
                      <th scope="col" class="text-secondary">Disponibilité</th>
                      <th scope="col" class="text-secondary text-center">
                        Choix
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr
                      *ngFor="let article of filteredArticleList; let i = index"
                      style="font-size: small"
                    >
                      <th scope="row">{{ article.libelle }}</th>
                      <th scope="row">
                        {{ stocksDisponibles[article.liquide.id] }}
                      </th>
                      <td class="">
                        <input
                          type="checkbox"
                          class="form-control-custom"
                          [name]="'checkbox_' + i"
                          [(ngModel)]="article.isChecked"
                          (change)="onCheckboxChange(article)"
                          [disabled]="
                            stocksDisponibles[article.liquide.id] <= 0
                          "
                        />
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </fieldset>
          </div>
        </form>
      </div>
      <div class="modal-footer gap-3 px-4y">
        <button
          (click)="OnCloseChoiceModal()"
          type="button"
          class="btn btn-secondary px-2"
        >
          Annuler
        </button>
        <button
          type="submit"
          (click)="onSubmitSelection()"
          class="btn btn-primary px-2"
        >
          Valider
        </button>
      </div>
    </div>
  </div>
</div>
