<div
  class="gap-2 d-flex align-items-center mb-3"
  style="cursor: pointer"
  (click)="goBack()"
>
  <i style="font-size: 18px" class="fas fw-bold fa-chevron-left me-2"></i>
  <h4 class="fw-bold mb-0">Livraisons</h4>
</div>

<div class="card">
  <div class="d-flex justify-content-end py-3">
    <button type="button" class="btn btn-secondary px-4" (click)="OnCreate()">
      Faire un regroupement
    </button>
  </div>
  <p-table
    [styleClass]="'p-datatable-sm'"
    #dt2
    [value]="listRegroupements"
    dataKey="id"
    [rows]="8"
    [totalRecords]="totalPages" [lazy]="true"
    [rowsPerPageOptions]="[10, 25, 50]"
    [paginator]="true"
    (onPage)="onPage($event)"
  >
    <ng-template pTemplate="header">
      <tr>
        <th style="color: var(--secondary-color)">N° Regroupement</th>
        <th style="color: var(--secondary-color)">Nbre commandes</th>
        <th style="color: var(--secondary-color)">Conducteur</th>
        <th style="color: var(--secondary-color)">Montant (FCFA)</th>
        <th style="color: var(--secondary-color)">Statut</th>
        <th style="color: var(--secondary-color)">Actions</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-dataList>
      <tr>
        <td>
          <span class="ml-1 vertical-align-middle">
            {{ dataList.numRegroupement }}
          </span>
        </td>
        <td>
          {{ dataList.commandes.length }}
        </td>
        <td>
          <span class="ml-1 vertical-align-middle">
            {{ dataList.transporteur.nom }}  {{ dataList.transporteur.prenoms }}
          </span>
        </td>
        <td>
          {{ getTotalGeneral(dataList.commandes) || 0 | number:'1.0-0' }}
        </td>
        <td>
          <span class="ml-1 vertical-align-middle">
             {{ dataList.statut }}
          </span>
        </td>

        <td>
          <tr class="d-flex justify-content-center gap-3">
            <td>
              <i
                (click)="OnView(dataList)"
                style="cursor: pointer"
                class="fas fa-eye text-secondary"
              ></i>
            </td>
          </tr>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="5">Aucune commande trouvé.</td>
      </tr>
    </ng-template>
  </p-table>
</div>

<!-- Modal creation -->
<!-- Modal -->

<div *ngIf="isModalOpen" class="custom-modal">
  <div
    class="modal-dialog modal-dialog-centered"

  >
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Regroupement</h5>
        <button type="button" class="btn-close" aria-label="Close"></button>
      </div>

      <div
        class="modal-body"
        style="padding: 20px; max-height: 70vh; overflow-y: auto"
      >
        <div class="row">
          <div class="col-md-7">
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="zone" class="form-label">Zone de livraison*</label>
                <ng-select
                  class="form-control"
                  [items]="listZone"
                  bindLabel="nomZone"
                  bindValue="id"
                  [searchable]="true"
                  (change)="onZoneChange($event)"
                >
                </ng-select>
              </div>
            </div>
            <div
              class="table-responsive"
              style="max-height: 400px; overflow-y: auto"
            >
              <table class="table table-bordered table-hover">
                <thead class="table-success">
                <tr>
                  <th>Commande</th>
                  <th>Établissements</th>
                  <th>Casier</th>
                  <th>Zone livraison</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                <tr *ngFor="let item of filteredList; let i = index">
                  <td>{{ item.NumCommande }}</td>
                  <td> {{ item.client.nomEtablissement ? item.client.nomEtablissement : item.client.raisonSocial}}
                  </td>
                  <td>{{ getTotalQuantite(item.articles) }}</td>
                  <td>{{ item.client.zoneDeLivraison.nomZone }}</td>
                  <td>{{ item.createdAt|date }}</td>
                  <td class="">
                    <input
                      type="checkbox"
                      class="form-control-custom"
                      [disabled]="this.livraisonForm.controls['vehicule'].invalid"
                      [name]="'checkbox_' + i"
                      [(ngModel)]="item.isChecked"
                      (change)="onCheckboxChange(item)"
                    />

                  </td>
                </tr>
                <tr *ngIf="filteredList.length == 0" ><td colspan="6"><label class="text-center">Pas de commande en cours.</label></td></tr>
                </tbody>
              </table>
            </div>

          </div>

            <div class="col-md-5">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0">Informations sur le regroupement</h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <!-- Première colonne -->
                    <div class="col-12">
                      <form [formGroup]="livraisonForm">
                        <div class="mb-3">
                          <label for="transporteur" class="form-label">Transporteur</label>
                          <ng-select
                            class="form-control"
                            [items]="listTransporteur"
                            bindLabel="displayName"
                            formControlName="transporteur"
                            bindValue="id"
                            [searchable]="true"
                          >
                          </ng-select>
                        </div>
                        <div class="mb-3">
                          <label for="chauffeur" class="form-label">Véhicule</label>
                          <ng-select
                            class="form-control"
                            [items]="listVehicule"
                            (change)="onVehiculeChange($event)"
                            bindLabel="displayName"
                            formControlName="vehicule"
                            bindValue="id"
                            [searchable]="true"
                          >
                          </ng-select>
                        </div>
                      </form>

                    </div>
                  </div>
                  <div class="row">
                    <table class="table table-bordered table-hover">
                      <thead class="table-success">
                      <tr>
                        <td colspan="1">
                          <i class="fa-sharp fa-solid fa-truck-ramp-couch"></i>
                        </td>
                        <td colspan="2">{{ cargaison }} / {{ truckCapacity }}</td>
                      </tr>
                      <tr>
                        <th>Format</th>
                        <th>Type</th>
                        <th>Palette</th>
                        <th>Casier</th>
                      </tr>
                      </thead>
                      <tbody>
                      <!-- Boucle sur chaque format -->
                      <ng-container *ngFor="let item of regroupementFinal | keyvalue">
                        <!-- Boucle sur chaque type d'article pour ce format -->
                        <tr *ngFor="let subItem of item.value">
                          <td>{{ item.key }}</td>
                          <td>{{ subItem.type }}</td>
                          <td>{{ subItem.palettes }}</td>
                          <td>{{ subItem.casier }}</td>
                        </tr>
                      </ng-container>
                      </tbody>
                    </table>

                  </div>
                </div>
              </div>
            </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="modal-footer gap-3 px-4">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="OnCloseModal()"
        >
          Annuler
        </button>
        <button [disabled]="commandeList.length <=0 || cargaison >= truckCapacity || livraisonForm.invalid" type="submit" class="btn btn-primary" (click)="onSubmit()">
          Valider
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal détail -->
<!-- Modal -->
<div *ngIf="isModalOpenDetail" class="custom-modal">
  <div
    class="modal-dialog modal-dialog-centered"
    style="width: 90%; max-width: 1200px"
  >
    <div class="modal-content">
      <!-- Header -->
      <div class="modal-header">
        <h5 class="modal-title text-success">Regroupement</h5>
        <button type="button" class="btn-close" aria-label="Close"></button>
      </div>

      <!-- Body -->
      <div
        class="modal-body"
        style="padding: 20px; max-height: 70vh; overflow-y: auto"
      >
        <div class="row">
          <!-- Regroupement et Zone -->
          <div class="col-md-12 d-flex mb-3 align-items-end">
            <div class="me-3">
              <label for="numRegroupement" class="form-label"
                >N° Regroupement</label
              >
              <input
                type="text"
                id="numRegroupement"
                class="form-control"
                [value]=updateData.numRegroupement
                readonly
              />
            </div>
            <div class="me-3">
              <label for="camion" class="form-label">Camion</label>
              <input
                type="text"
                id="camion"
                class="form-control"
                [attr.value]="updateData?.vehicule?.marque"
                readonly
              />
            </div>
            <div class="me-3">
              <label for="chauffeur" class="form-label">Chauffeur</label>
              <input
                type="text"
                id="chauffeur"
                class="form-control"
                [attr.value]="updateData?.transporteur?.nom + ' ' + updateData?.transporteur?.prenoms"
                readonly
              />
            </div>
            <div>
              <button
                type="button"
                class="btn btn-secondary px-4"
                (click)="UploadDoc(updateData)"
              >
                Imprimer
              </button>
            </div>
          </div>

          <div class="col-md-12 d-flex">

          </div>
        </div>
        <div class="col-md-12">

          <div class="row">
            <div class="container">
              <table class="table table-bordered">
                <thead>
                <tr>
                  <th>Raison Sociale</th>
                  <th class="text-center" *ngFor="let article of allArticles">{{ article.libelle }}</th>
                </tr>
                </thead>
                <tbody>
                <tr *ngFor="let retour of updateData.commandes; let i = index">
                  <td>{{ retour.clientInfo.raisonSocial || retour.clientInfo.nomEtablissement }}</td>
                  <td class="text-center" *ngFor="let article of allArticles">
                    {{ getQuantity(retour, article.libelle) }}
                  </td>
                </tr>
                <tr class="font-weight-bold">
                  <td class="fw-bold">Total</td>
                  <td class="text-center" *ngFor="let article of allArticles">
                    {{ article.expectedQuantity }}
                  </td>
                </tbody>
              </table>

              <table class="table table-bordered table-hover">
                <thead class="table-success">
                <tr>
                  <th>Format</th>
                  <th>Type</th>
                  <th>Palette</th>
                  <th>Casier</th>
                </tr>
                </thead>
                <tbody>
                <!-- Boucle sur chaque format -->
                <ng-container *ngFor="let item of regroupementFinal | keyvalue">
                  <!-- Boucle sur chaque type d'article pour ce format -->
                  <tr *ngFor="let subItem of item.value">
                    <td>{{ item.key }}</td>
                    <td>{{ subItem.type }}</td>
                    <td>{{ subItem.palettes }}</td>
                    <td>{{ subItem.casier }}</td>
                  </tr>
                </ng-container>
                </tbody>
              </table>

              <fieldset class="row border my-2">
                <legend>Evolutions</legend>
                <table class="table table-bordered">
                  <thead>
                  <tr>
                    <th>Commande</th>
                    <th>Raison Sociale</th>
                    <th>Debut</th>
                    <th>Fin</th>
                    <th>Statut</th>
                    <th>Signature</th>
                  </tr>
                  </thead>
                  <tbody>
                  <tr *ngFor="let retour of updateData.livraisons; let i = index">
                    <td>
                      {{ retour.commande?.NumCommande}}
                    </td>
                    <td>
                      {{ retour.commande?.clientInfo.raisonSocial || retour.commande.clientInfo.nomEtablissement }}
                    </td>
                    <td>
                      {{ retour?.dateLivraisonDebut | date: 'dd/MM/yyyy HH:mm' || ''}}
                    </td>
                    <td>
                      {{ retour.dateLivraisonFin | date: 'dd/MM/yyyy HH:mm' || '' }}
                    </td>
                    <td>
                      {{ retour.commande.statut || '' }}
                    </td>
                    <td *ngIf="retour.signatureClient">
                      <i
                        (click)="OnViewSign(retour.signatureClient)"
                        style="cursor: pointer"
                        class="fas fa-eye text-secondary"
                      ></i>
                    </td>
                  </tr>
                  </tbody>
                </table>
              </fieldset>
            </div>
          </div>
        </div>
      </div>

          <!-- Table des commandes -->
      <div class="modal-footer gap-3 px-4">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="closeDetailModal()"
        >
          Fermer
        </button>
      </div>
    </div>
  </div>
</div>



<!-- Modal détail -->
<!-- Modal -->
<div *ngIf="isModalOpenSign" class="custom-modal">
  <div
    class="modal-dialog-sign modal-dialog-centered"
    style=" max-width: 1200px"
  >
    <div class="modal-content">
      <!-- Header -->
      <div class="modal-header">
        <h5 class="modal-title text-success">Signature</h5>
        <button type="button" class="btn-close" aria-label="Close"></button>
      </div>

      <!-- Body -->
      <div
        class="modal-body"
        style="padding: 20px; max-height: 70vh; overflow-y: auto"
      >
        <div class="row">
          <!-- Regroupement et Zone -->
        </div>
        <div class="col-md-12">
          <div class="row">
            <div class="container">
              <img style="width:100%;height:100%" *ngIf="signature" [src]=signature alt="">
            </div>
          </div>
        </div>
      </div>

      <!-- Table des commandes -->
      <div class="modal-footer gap-3 px-4">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="closeDetailSign()"
        >
          Fermer
        </button>
      </div>
    </div>
  </div>
</div>
