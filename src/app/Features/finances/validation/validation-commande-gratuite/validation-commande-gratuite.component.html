<div class="card">

    <p-table
      [styleClass]="'p-datatable-sm'"
      #dt2
      [value]="ListCommandeGratuites"
      dataKey="id"
      [rows]="8"
    [totalRecords]="totalPages" [lazy]="true"

      [rowsPerPageOptions]="[10, 25, 50]"
      [paginator]="true"
      (onPage)="onPage($event)"
    >
      <ng-template pTemplate="header">
        <tr>
          <th style="color: var(--secondary-color)">N° commande</th>
          <th style="color: var(--secondary-color)">Etablissement</th>
  <!--        <th style="color: var(&#45;&#45;secondary-color)">Depôt</th>-->
          <th style="color: var(--secondary-color)">Quantité</th>
          <th style="color: var(--secondary-color)">Statut</th>
          <th style="color: var(--secondary-color)">Actions</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-ListCommandeGratuites let-i="index">
        <tr>
          <td>
            {{ ListCommandeGratuites.NumCommande }}
          </td>

          <td>
            {{ ListCommandeGratuites.client.raisonSocial ? ListCommandeGratuites.client.raisonSocial : ListCommandeGratuites.client.nomEtablissement }}
          </td>
  <!--        <td>-->
  <!--          {{ ListCommandeGratuites.revendeur.depot.nomDepot }}-->
  <!--        </td>-->
          <td>
            <span class="ml-1 vertical-align-middle">
  <!--            {{ ListCommandeGratuites.articles[i].quantite }}-->
            </span>
          </td>
          <td>
            <span class="ml-1 vertical-align-middle">
                          {{ ListCommandeGratuites.statut }}
                      </span>
          </td>
          <td>
            <tr class="d-flex justify-content-center gap-3">
              <td>
                <i
                  (click)="OnEdit(ListCommandeGratuites)"
                  style="cursor: pointer"
                  class="fas fa-eye text-secondary"
                ></i>
              </td>
            </tr>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="5">Aucune commande trouvé.</td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <!-- Modal creation -->
  <!-- Modal -->
  <div *ngIf="isModalOpen" class="custom-modal">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header d-flex align-items-center">
          <div
            class="d-flex justify-content-center align-items-center"
            style="
              background-color: rgb(219, 255, 232);
              border-radius: 3rem;
              width: 3rem;
              height: 3rem;
            "
          >
            <i class="fas fa-box-check text-primary fs-3"></i>
          </div>
          <h1
            *ngIf="operation == 'create'"
            class="modal-title fs-5 ms-3"
            id="staticBackdropLabel"
          >
            Création de la commande
          </h1>
          <h1
            *ngIf="operation == 'edit'"
            class="modal-title fs-5 ms-3"
            id="staticBackdropLabel"
          >
            Validation de la commande
          </h1>
        </div>
        <div class="modal-body">

          <fieldset class="row border my-1"  *ngIf="operation == 'edit'">
            <legend style="font-size: 14px;" class="text-secondary">Numero Commande : {{updateData.NumCommande}} du {{updateData.createdAt | date}}</legend>
          </fieldset>
          <fieldset class="row border my-2"  *ngIf="operation == 'edit'">
            <legend style="font-size: 14px;" class="text-secondary">Informations du client</legend>
            <div class="row">
              <div class="col-md-4">
                <strong>Groupe de client :</strong>
                <span>{{ updateData.client?.groupeClient?.nomGroupe || updateData.client?.GroupeClient?.nomGroupe }}</span>

              </div>
              <div class="col-md-4">
                <strong>Type de client :</strong>
                <span>{{updateData.client.role}}</span>
              </div>
              <div class="col-md-4">
                <strong>Propriétaire :</strong>
                <span>{{ updateData.client.nomProprietaire }}</span>
              </div>
              <div class="col-md-4">
                <strong>Gérant :</strong>
                <span>{{ updateData.client.nomGerant }}</span>
              </div>
              <div class="col-md-4">
                <strong>Établissement :</strong>
                <span>{{ updateData.client.nomEtablissement ? updateData.client.nomEtablissement : updateData.client.raisonSocial }}</span>
              </div>
              <div class="col-md-4">
                <strong>Numero de registre :</strong>
                <span>{{ updateData.client.numeroRegistre }}</span>
              </div>
              <div class="col-md-4">
                <strong>Numero contribuable :</strong>
                <span>{{ updateData.client.numeroCompteContribuable }}</span>
              </div>
              <div class="col-md-4">
                <strong>Contact Gérant :</strong>
                <span>{{ updateData.client.telephoneGerant }}</span>
              </div>
              <div class="col-md-4 mb-4">
                <strong>Téléphone :</strong>
                <span>{{ updateData.client.telephoneProprietaire }}</span>
              </div>
              <div class="col-md-4">
                <strong>Délai : </strong>
                <span>{{ updateData?.credit?.delaiReglement || "NA" }}Jours</span>
              </div>
              <div class="col-md-4">
                <strong>Date échéance : </strong>
                <span>{{ updateData?.dateEchanceCalculer | date: "dd/MM/yyyy HH:mm"  }}</span>
              </div>
            </div>
          </fieldset>
          <div class="p-2 mt-3">
            <div style="max-height: 350px; overflow-y: auto">
              <table  *ngIf="operation == 'create'" class="table table-bordered">
                <thead class="table-success">
                  <!-- Première ligne d'en-tête -->
                  <tr>
                    <th scope="col" colspan="5">PRIX UNITAIRE TTC(FCFA)</th>
                    <th scope="col" colspan="4">MONTANT TTC(FCFA)</th>
                  </tr>
                  <!-- Deuxième ligne d'en-tête -->
                  <tr>
                    <th scope="col">Liquide</th>
                    <th scope="col">Liquide (FCFA)</th>
                    <th scope="col">Emballage (FCFA)</th>
                    <th scope="col">Total (FCFA)</th>
                    <th scope="col">Qte</th>
                    <th scope="col">Liquide (FCFA)</th>
                    <th scope="col">Emballage (FCFA)</th>
                    <th scope="col">Total (FCFA)</th>
                    <th scope="col">Actions</th>
                  </tr>
                </thead>

                <tbody>
                  <tr *ngFor="let item of selectedArticles">
                    <td>{{ item.liquide.libelle }}</td>
                    <td>{{ prixLiquide[item.id] | number}}</td>
                    <td>{{ prixEmballage[item.id] | number}}</td>
                    <td>{{ prixEmballage[item.id] + prixLiquide[item.id] | number}}</td>
                    <td>
                      <input
                        type="number"
                        class="form-control-custom"
                        [(ngModel)]="item.quantite"
                        [min]="0"
                        [max]="stocksDisponibles[item.liquide.id]"
                        [disabled]="stocksDisponibles[item.liquide.id] === 0"
                        [ngClass]="{
                          invalid: item.quantite > stocksDisponibles[item.liquide.id]
                        }"
                        (blur)="validateQuantite(item)"
                      />
                      / {{stocksDisponibles[item.liquide.id]}}
                    </td>
                    <td>{{ prixLiquideTotal[item.id] | number}}</td>
                    <td>{{ prixEmballageTotal[item.id] | number}}</td>
                    <td>{{ montantTotal[item.id] | number}}</td>
                    <td class="d-flex justify-content-center">
                      <button
                        type="button"
                        class="btn btn-danger btn-sm"
                        (click)="removeArticle(item)"
                      >
                        <i class="fas fa-trash"></i>
                      </button>
                    </td>
                  </tr>
                  <tr class="table-dark">
                    <th scope="col" colspan="4">Total :</th>
                    <td>{{ totalQte | number}}</td>
                    <td>{{ totalLiquide | number}}</td>
                    <td>{{ totalEmballage | number}}</td>
                    <td>{{ totalGlobal | number}}</td>
                    <td></td>
                  </tr>
                </tbody>
              </table>
              <table  *ngIf="operation == 'edit'" class="table table-bordered">
                <thead class="table-success">
                <!-- Première ligne d'en-tête -->
                <tr>
                  <th scope="col" colspan="5">PRIX UNITAIRE TTC(FCFA)</th>
                  <th scope="col" colspan="3">MONTANT TTC(FCFA)</th>
                </tr>
                <!-- Deuxième ligne d'en-tête -->
                <tr>
                  <th scope="col">Liquide</th>
                  <th scope="col">Liquide (FCFA)</th>
                  <th scope="col">Emballage (FCFA)</th>
                  <th scope="col">Total (FCFA)</th>
                  <th scope="col">Qte</th>
                  <th scope="col">Liquide (FCFA)</th>
                  <th scope="col">Emballage (FCFA)</th>
                  <th scope="col">Total (FCFA)</th>
                </tr>
                </thead>

                <tbody>
                <tr *ngFor="let item of updateData.articles">
                  <td>{{ item.liquide.libelle }}1</td>
                  <td>{{ item.prixUnitaireLiquide| number }}</td>
                  <td>{{ item.prixUnitaireEmballage| number}}</td>
                  <td>{{  Number(item.prixUnitaireLiquide ?? 0) + Number(item.prixUnitaireEmballage ?? 0) }}</td>
                  <td>{{ item.quantite }}</td>
                  <td>{{ item.montantLiquide | number}}</td>
                  <td>{{ item.montantEmballage | number}}</td>
                  <td>{{Number(item.montantLiquide ?? 0) + Number(item.montantEmballage ?? 0) }}</td>

                </tr>
                <tr class="table-dark">
                  <th scope="col" colspan="4">Total :</th>
                  <td>{{ totalQte | number}}</td>
                  <td>{{ totalLiquide| number }}</td>
                  <td>{{ totalEmballage | number}}</td>
                  <td>{{ totalGlobal| number }}</td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="modal-footer gap-3 px-4">
          <button
            (click)="OnCloseModal()"
            type="button"
            class="btn btn-secondary px-2"
          >
            Annuler
          </button>
          <button (click)="ApprouverCommande(updateData)" class="btn btn-success">Approuver</button>

        </div>
      </div>
    </div>
  </div>

  <!--CHOIX ARTICLE-->
  <div *ngIf="isChoiceModalOpen" class="custom-modal">
    <div class="modal-dialog2 modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header d-flex align-items-center">
          <div
            class="d-flex justify-content-center align-items-center"
            style="
              background-color: rgb(219, 255, 232);
              border-radius: 3rem;
              width: 3rem;
              height: 3rem;
            "
          >
            <i class="fas fa-box-check text-primary fs-3"></i>
          </div>
          <h1 class="modal-title fs-5 ms-3" id="staticBackdropLabel">
            Selection des articles
          </h1>
        </div>

        <div class="modal-body">
          <form>
            <div class="row">
              <fieldset class="row border my-2">
                <div class="p-3">
                  <!-- Champ de recherche -->
                  <input
                    type="text"
                    name="search"
                    (input)="filterArticles()"
                    [(ngModel)]="searchTerm"
                    placeholder="Rechercher un produit"
                    class="form-control mb-3"
                  />
                </div>
                <div
                  class="table-responsive"
                  style="max-height: 200px; overflow-y: auto"
                >
                  <table class="table">
                    <thead>
                      <tr style="font-size: small">
                        <th scope="col" class="text-secondary">Code</th>
                        <th scope="col" class="text-secondary">Produits</th>
                        <th scope="col" class="text-secondary">Disponibilité</th>
                        <th scope="col" class="text-secondary text-center">
                          Choix
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr
                        *ngFor="let article of filteredArticleList ; let i = index"
                        style="font-size: small"
                      >
                        <th scope="row">{{ article.code }}</th>
                        <th scope="row">{{ article.libelle }}</th>
                        <th scope="row">{{stocksDisponibles[article.liquide.id]}}</th>
                        <td class="">
                          <input
                            type="checkbox"
                            class="form-control-custom"
                            [name]="'checkbox_' + i"
                            [(ngModel)]="article.isChecked"
                            (change)="onCheckboxChange(article)"
                            [disabled]="stocksDisponibles[article.liquide.id] <=0"
                          />

                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </fieldset>
            </div>
          </form>
        </div>
        <div class="modal-footer gap-3 px-4y">
          <button
            (click)="OnCloseChoiceModal()"
            type="button"
            class="btn btn-secondary px-2"
          >
            Annuler
          </button>
          <button

            type="submit"
            (click)="onSubmitSelection()"
            class="btn btn-primary px-2"
          >
            Valider
          </button>
        </div>
      </div>
    </div>
  </div>
